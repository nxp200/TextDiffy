"use strict";export const AppState={whitespaceSensitive:!0,caseSensitive:!0,granularity:"line"};const $=e=>document.querySelector(e);function normalizeLine(e,t){let n=e;return t.whitespaceSensitive||(n=n.replace(/\s+/g," ").trim()),t.caseSensitive||(n=n.toLowerCase()),n}function splitLines(e){return e.replace(/\r\n?/g,"\n").split("\n")}function yieldToUI(){return new Promise(e=>setTimeout(e,0))}function tokenizeWords(e){try{const t=e.match(/[\p{L}\p{N}_]+|\s+|[^\s\p{L}\p{N}_]/gu);return t??[e]}catch(t){const n=e.match(/[A-Za-z0-9_]+|\s+|[^\sA-Za-z0-9_]/g);return n??[e]}}function tokenizeChars(e){return Array.from(e)}function patienceDiff(e,t,n=(e,t)=>e===t){const r=[];function a(a,i,s,o){for(;a<i&&s<o&&n(e[a],t[s]);)r.push({op:"equal",a:e[a],b:t[s]}),a++,s++;for(;a<i&&s<o&&n(e[i-1],t[o-1]);)i--,o--,r.push({op:"equal-suf",a:e[i],b:t[o]});if(a===i){for(let e=s;e<o;e++)r.push({op:"insert",b:t[e]});return}if(s===o){for(let t=a;t<i;t++)r.push({op:"delete",a:e[t]});return}const l=new Map,c=new Map;for(let t=a;t<i;t++)l.set(e[t],(l.get(e[t])||0)+1);for(let e=s;e<o;e++)c.set(t[e],(c.get(t[e])||0)+1);const u=new Map;for(let e=s;e<o;e++){const n=t[e];1===c.get(n)&&u.set(n,e)}const d=[];for(let t=a;t<i;t++){const n=e[t];1===l.get(n)&&u.has(n)&&d.push([t,u.get(n)])}const f=[],p=new Array(d.length).fill(-1),h=new Array(d.length).fill(-1);for(let e=0;e<d.length;e++){const t=d[e][1];let n=0,a=f.length;for(;n<a;){const e=n+a>>1;f[e][1]<t?n=e+1:a=e}n>0&&(p[e]=h[n-1]),f[n]=d[e],h[n]=e}const y=[];let g=h[f.length-1];for(;g>=0;)y.push(d[g]),g=p[g];if(y.reverse(),0===y.length){for(let t=a;t<i;t++)r.push({op:"delete",a:e[t]});for(let e=s;e<o;e++)r.push({op:"insert",b:t[e]});return}let m=a,b=s;for(const[e,t]of y)m<e||b<t&&a(m,e,b,t),r.push({op:"equal",a:e[e],b:t[t]}),m=e+1,b=t+1;(m<i||b<o)&&a(m,i,b,o)}a(0,e.length,0,t.length);const i=[],s=[];for(const e of r)"equal-suf"===e.op?s.push({op:"equal",a:e.a,b:e.b}):i.push(e);return i.concat(s)}function collapseToModify(e){const t=[];for(let n=0;n<e.length;n++){const r=e[n];if("delete"===r.op&&n+1<e.length&&"insert"===e[n+1].op){t.push({op:"modify",old:r.a,new:e[n+1].b}),n++;continue}"equal"===r.op?t.push(r):"insert"===r.op?t.push({op:"insert",b:r.b}):"delete"===r.op&&t.push({op:"delete",a:r.a})}return t}function granularLineDiff(e,t,n){if("line"===n)return null;const r="word"===n?tokenizeWords(e):tokenizeChars(e),a="word"===n?tokenizeWords(t):tokenizeChars(t),i=patienceDiff(r,a,(e,t)=>e===t),s=[];for(const e of i)"equal"===e.op?s.push({type:"same",text:e.a}):"insert"===e.op?s.push({type:"add",text:e.b}):"delete"===e.op&&s.push({type:"remove",text:e.a});return s}export async function buildStructuredDiff(e,t,n=AppState){const r=splitLines(e),a=splitLines(t),i=r.map(e=>normalizeLine(e,n)),s=a.map(e=>normalizeLine(e,n)),o=patienceDiff(i,s,(e,t)=>e===t),l=collapseToModify(o),c=[];let u=0,d=0;for(const e of l){if("equal"===e.op)c.push({type:"same",line:r[u]}),u++,d++;else if("insert"===e.op)c.push({type:"add",line:a[d]}),d++;else if("delete"===e.op)c.push({type:"remove",line:r[u]}),u++;else if("modify"===e.op){const e=r[u],t=a[d],n=granularLineDiff(e,t,n.granularity);c.push({type:"modify",old:e,new:t,parts:n}),u++,d++}(u+d)%2e3==0&&await yieldToUI()}return c}function clearNode(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function renderTokenSpan(e){const t=document.createElement("span");return t.className="add"===e.type?"token-add":"remove"===e.type?"token-remove":"token-same",t.textContent=e.text,t}export function renderDiff(e){const t=$("#diffOutput");clearNode(t);const n=document.createDocumentFragment();for(const t of e){const e=document.createElement("div");e.className=`diff-line ${t.type}`;const r=document.createElement("span");r.className="prefix";const a=document.createElement("div");if(a.className="modify"===t.type?"inline-lines":"inline-line","same"===t.type)r.textContent=" ",a.appendChild(Object.assign(document.createElement("div"),{className:"inline-line",textContent:t.line}));else if("add"===t.type)r.textContent="+",a.appendChild(Object.assign(document.createElement("div"),{className:"inline-line",textContent:t.line}));else if("remove"===t.type)r.textContent="âˆ’",a.appendChild(Object.assign(document.createElement("div"),{className:"inline-line",textContent:t.line}));else if("modify"===t.type){r.textContent="~";const e=document.createElement("div");e.className="inline-line",e.setAttribute("aria-label","Modified old line");const n=document.createElement("div");if(n.className="inline-line",n.setAttribute("aria-label","Modified new line"),t.parts&&Array.isArray(t.parts))for(const r of t.parts)("same"===r.type||"remove"===r.type)&&e.appendChild(renderTokenSpan({type:"same"===r.type?"same":"remove",text:"add"===r.type?"":r.text})),("same"===r.type||"add"===r.type)&&n.appendChild(renderTokenSpan({type:"same"===r.type?"same":"add",text:"remove"===r.type?"":r.text}));else e.textContent=t.old,n.textContent=t.new;a.appendChild(e),a.appendChild(n)}e.appendChild(r),e.appendChild(a),n.appendChild(e)}t.appendChild(n)}export function updateMetrics(e){let t=0,n=0,r=0;for(const a of e)"add"===a.type?t++:"remove"===a.type?n++:"modify"===a.type&&r++;$("#total-added").textContent=String(t),$("#total-removed").textContent=String(n),$("#total-modified").textContent=String(r)}export function serializePlain(e){const t=[];for(const n of e)"same"===n.type?t.push("  "+n.line):"add"===n.type?t.push("+ "+n.line):"remove"===n.type?t.push("- "+n.line):"modify"===n.type&&(t.push("- "+n.old),t.push("+ "+n.new),n.parts&&t.push("~ "+n.parts.map(e=>"add"===e.type?"{+"+e.text+"+}":"remove"===e.type?"{-"+e.text+"-}":e.text).join("")));return t.join("\n")}async function copyToClipboard(e){try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{return document.execCommand("copy"),!0}catch(e){return!1}finally{document.body.removeChild(t)}}function downloadText(e,t){const n=new Blob([t],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r,a.download=e,document.body.appendChild(a),a.click(),setTimeout(()=>{URL.revokeObjectURL(r),document.body.removeChild(a)},0)}export async function runCompare(){const e=$("#inputA").value,t=$("#inputB").value,n={...AppState},r=performance.now(),a=await buildStructuredDiff(e,t,n);return renderDiff(a),updateMetrics(a),performance.now()-r>200&&await yieldToUI(),a}function bindUI(){const e=$("#whitespaceSensitive"),t=$("#caseSensitive"),n=$("#granularity");e.addEventListener("change",(()=>{AppState.whitespaceSensitive=e.checked})),t.addEventListener("change",(()=>{AppState.caseSensitive=t.checked})),n.addEventListener("change",(()=>{AppState.granularity=n.value})),$("#compareBtn").addEventListener("click",(async()=>{await runCompare()})),$("#copyBtn").addEventListener("click",(async()=>{const e=await runCompare(),t=serializePlain(e);(await copyToClipboard(t))||alert("Copy failed: your browser may not support clipboard APIs.")})),$("#exportBtn").addEventListener("click",(async()=>{const e=await runCompare(),t=serializePlain(e);downloadText("textdiffy-diff.txt",t)}))}document.addEventListener("DOMContentLoaded",bindUI);export const __internals={splitLines,normalizeLine,tokenizeWords,tokenizeChars,patienceDiff,granularLineDiff};
